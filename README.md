# AI EPUB 翻译助手

这是一款专门为电子书（EPUB）设计的翻译工具。它能够在翻译内容的同时，精准保留原文件的所有排版、图片和文字样式。

---

### 1. 获取与运行方法 (推荐)

本项目推荐通过 Git 直接获取源码运行，以便随时同步最新的功能修复。

#### 首次安装
1. **克隆仓库**：
   ```bash
   git clone https://github.com/31naitnij/AI-EPUB-Translator.git
   cd AI-EPUB-Translator
   ```
2. **一键启动**：
   - **Windows**: 双击运行 **`run.bat`**
   - **macOS / Linux**: 在终端执行 **`./run.sh`**

> [!NOTE]
> `run.bat` 会自动检测并为您创建 Python 虚拟环境 (`.venv`) 并安装所有必需依赖，无需手动操作。

#### 同步更新
若要获取修复或新功能（如：搜索框、回填容错增强），只需在文件夹内运行：
```bash
git pull origin master
```
完成同步后，直接运行 `run.bat` 即可享受最新更新。

#### 自行构建 (可选)
如果您希望生成一个独立的可执行文件：
- **Windows**: 运行 **`build_exe.bat`**。
- 生成的文件将位于 `dist/EPUB_Translator.exe`。

---

### 2. 使用说明

工具界面简洁直观，主要分为以下三个区域：

*   **顶部配置区**：在这里选择您需要翻译的 EPUB 文件，并填写 AI 服务的地址、密钥和模型名称。您还可以调整“分块字符数”（建议 1000-1500），这决定了每次交给 AI 处理的文字量。
*   **左侧任务区**：点击“分块并分组”后，程序会将整本书拆分成多个任务块。在此可以查看翻译进度，并支持通过 Ctrl/Shift 键多选任务进行批量处理。
*   **右侧对照区**：选中一个任务后，右侧会显示原文与译文的对照。您可以直接编辑译文，修改后点击“保存组修改”即可即时保存。

---

### 3. 工作流程简介

本工具遵循一套严谨的处理流程，确保文档安全：
1.  **解压缩**：将电子书拆解为原始的文本和图片资源。
2.  **分块**：将长篇文字切分为适合 AI 处理的短句和段落。
3.  **抽取**：剥离复杂的排版代码，仅提取需要翻译的纯文本。
4.  **翻译**：通过 AI 服务将内容转换为中文。
5.  **回填**：根据标记将中文精准放回原有的排版位置。
6.  **打包**：重新封装文件，生成排版完美的中文 EPUB 电子书。

---

### 4. 关键步骤原理

*   **抽取与回填**：为了让 AI 不被复杂的排版代码干扰，我们使用 `[[n]]` 标记行号，用 `((A))` 标记文字样式（如加粗或链接）。AI 翻译时只需保持标记不动，程序就能在“回填”时根据标记自动复原样式。**目前程序已具备回填容错性：只要 `[[n]]` 行标签对应，即便内部 `((A))` 标签不匹配或缺失，内容仍可成功回填（此时会忽略有问题的内部样式）。**
*   **颜色标记说明**：
    *   ⚪ **白色**：待处理的任务。
    *   ✅ **绿色**：翻译成功并已保存。
    *   🔴 **红色**：格式检测有误。这通常是因为 AI 在翻译时漏写了标记。此时编辑器会自动以红底高亮错误位置，方便您手动修正。

---

### 5. 注意事项

*   **AI 提示词设置**：建议在提示词中包含以下内容（您可以直接将其复制到工具的“Prompt”框中）：

```text
你是多语言翻译专家，将以下文本中的英文翻译为中文。
规则：
1. **行数一致**：输出的行数必须与输入的行数严格一致，不可合并、拆分。每一行被 [[n]] 包裹（如 [[1]]文本[[1]]），确保成对出现，不要中间换行。
2. **锚点保留**：严格保留每行内字母编号的锚点符号（如 ((A))文字((A))）的相对位置，确保成对出现，严禁修改。
3. **简洁输出**：直接输出翻译内容，不要有任何额外注释。

示例：
[[1]]I woke up late this morning,[[1]]
[[2]]I missed ((A))the bus((A)) to school.[[2]]
->
[[1]]我今天早上起晚了，[[1]]
[[2]]我错过了去学校的((A))公交车((A))。[[2]]
```
*   **格式不匹配的处理**：如果出现任务标红，通常是因为 AI 合并了段落。
    *   如果标记显示为“行不匹配”，您必须手动修正或重试。
    *   如果仅显示“内部锚点不平衡”，程序在生成电子书时会**自动忽略**这些错误标记并保留纯文本翻译。您也可以在右侧对照区手动修正这些 `((X))` 标签以恢复加粗/链接等样式。
*   **文件被占用**：启动翻译前，请关闭正在展示该文件的软件（如电子书阅读器），以防保存失败。

希望本工具能为您的阅读工作带来便利。
